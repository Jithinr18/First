<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ascend Fit Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (Used for elegant interface icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            /* HIGHLY AESTHETIC PALETTE */
            --accent-primary: #00E676; /* Bright Green */
            --accent-secondary: #536DFE; /* Deep Indigo Blue */
            --dark-bg: #050510; /* Near Black */
            --card-bg: #1A1A2E; /* Rich Dark Blue/Purple Card */
            --text-color: #F0F4FF; 
            --subtle-text: #A0A9B8; 
            --divider-color: #38384A;
        }

        /* Set custom font and background */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            overflow: hidden; /* Prevent body scroll during transitions */
        }
        
        /* --- PROFESSIONAL SCROLLBAR STYLING --- */
        #content-area::-webkit-scrollbar {
            width: 8px;
        }
        #content-area::-webkit-scrollbar-thumb {
            background-color: var(--accent-primary);
            border-radius: 4px;
            border: 2px solid var(--dark-bg);
        }
        #content-area::-webkit-scrollbar-track {
            background: var(--dark-bg);
        }
        .app-container { scrollbar-color: var(--accent-primary) var(--dark-bg); }

        /* Responsive Container */
        .app-container {
            width: 100%;
            max-width: 400px; 
            height: 90vh; 
            background-color: var(--dark-bg);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7);
            border-radius: 24px; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: box-shadow 0.3s ease;
        }
        @media (min-width: 768px) {
            .app-container {
                max-width: 768px; 
                height: 95vh;
            }
        }

        /* Nav & Gauge Styles */
        .bottom-nav { 
            background-color: var(--card-bg); 
            border-top: 1px solid var(--divider-color);
            z-index: 20;
        }
        .nav-button { 
            color: var(--subtle-text); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .nav-button:active { transform: scale(0.9); }
        .nav-button.active { color: var(--text-color); transform: translateY(-2px); }
        .nav-button.active .icon { 
            color: var(--accent-primary); 
            filter: drop-shadow(0 0 5px rgba(0, 230, 118, 0.5));
            animation: icon-pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes icon-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }

        .gauge-ring-bg { stroke: var(--divider-color); }
        .gauge-ring-fill {
            transition: stroke-dashoffset 1.5s cubic-bezier(0.22, 1, 0.36, 1);
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* System List Item Style */
        .list-group-item {
            padding: 12px 0;
            cursor: pointer;
            color: var(--text-color);
            transition: background-color 0.2s, transform 0.2s;
        }
        .list-group-item:hover {
            background-color: #333333;
            transform: translateX(5px);
        }
        .list-group-header {
            color: var(--accent-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            padding: 12px 0 6px 0;
        }
        .input-field {
            background-color: #333333;
            border: 1px solid #444444;
            color: var(--text-color);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(0, 230, 118, 0.2);
        }
        #fab-log-activity {
            box-shadow: 0 4px 12px rgba(0, 191, 165, 0.4);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s;
        }
        #fab-log-activity:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 16px rgba(0, 191, 165, 0.6);
        }

        /* --- VISUALIZATION CSS --- */
        .water-fill {
            transition: height 1s ease-in-out, fill 0.5s;
            transform-origin: bottom;
        }
        .calorie-bar {
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.5s;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5); 
        }
        .water-button {
             transition: all 0.2s ease-in-out;
             transform: scale(1.0);
        }
        .water-button:active {
             transform: scale(0.85);
        }
        .trend-line {
             transition: all 0.5s ease-out;
             stroke: var(--accent-primary);
             stroke-width: 2;
             fill: none;
             stroke-dasharray: 1000;
             stroke-dashoffset: 1000;
             animation: drawLine 2s ease-out forwards;
        }
        @keyframes drawLine {
            to { stroke-dashoffset: 0; }
        }

        .outer-ring { stroke: var(--accent-secondary); }
        .inner-ring { stroke: var(--accent-primary); }
        
        /* --- MODAL CENTERING & BACKDROP --- */
        .modal-backdrop {
            position: fixed; 
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50; 
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-content {
            animation: slideUpModal 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes slideUpModal {
            from { opacity: 0; transform: translateY(50px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        /* Close Button Style */
        .close-btn-absolute {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: #A0A0A0;
            cursor: pointer;
            z-index: 60;
            transition: transform 0.3s, color 0.3s;
        }
        .close-btn-absolute:hover {
            color: white;
            transform: rotate(90deg);
        }
        
        /* Aesthetic Card Styling */
        .card-glow {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), 0 0 10px rgba(0, 230, 118, 0.1);
            transition: transform 0.3s ease-out, box-shadow 0.3s;
        }
        .card-glow:hover {
             transform: translateY(-5px);
             box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6), 0 0 15px rgba(0, 230, 118, 0.2);
        }

        /* --- NEW ANIMATION UTILITIES --- */
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }

        .animate-enter {
            opacity: 0; /* Start hidden */
            animation: slideInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .animate-fade {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .animate-pop {
            animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        .animate-float {
            animation: float 4s ease-in-out infinite;
        }

        /* Stagger delays */
        .delay-0 { animation-delay: 0ms; }
        .delay-1 { animation-delay: 50ms; }
        .delay-2 { animation-delay: 100ms; }
        .delay-3 { animation-delay: 150ms; }
        .delay-4 { animation-delay: 200ms; }
        .delay-5 { animation-delay: 250ms; }
        .delay-6 { animation-delay: 300ms; }
        .delay-7 { animation-delay: 350ms; }
        .delay-8 { animation-delay: 400ms; }

        /* Interactive Elements */
        .btn-press {
            transition: transform 0.1s;
        }
        .btn-press:active {
            transform: scale(0.95);
        }

        header {
            transition: background-color 0.3s, padding 0.3s;
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="app-container">
        <!-- Header -->
        <header id="app-header" class="p-4 flex justify-between items-center bg-transparent sticky top-0 z-30 backdrop-blur-sm">
            <h1 id="header-title" class="text-2xl font-bold tracking-wider text-white transition-all duration-300">Home</h1>
            <div id="user-avatar" class="w-9 h-9 rounded-full flex items-center justify-center border-2 border-accent-primary text-sm font-semibold text-white cursor-pointer transition-all hover:scale-110 active:scale-90 shadow-md hover:shadow-green-500/50"
                 onclick="window.renderTab('profile')" style="background-color: var(--card-bg);">
                ?
            </div>
        </header>

        <!-- Loading Indicator -->
        <div id="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 z-50 transition-opacity duration-500">
            <svg class="animate-spin h-10 w-10 text-accent-primary mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-sm text-gray-400 animate-pulse">Initializing Ascend OS...</p>
        </div>
        
        <!-- Modal Container -->
        <div id="modal-container" class="hidden modal-backdrop" onclick="if(event.target === this) window.closeModal()"></div>

        <!-- Main Content Area -->
        <main id="content-area" class="flex-grow overflow-y-auto px-4 py-6 relative" style="background-color: var(--dark-bg);"></main>

        <!-- FAB -->
        <button id="fab-log-activity" onclick="window.openActivityModal('Workout')" 
                class="hidden fixed right-6 bottom-20 w-14 h-14 rounded-full shadow-lg text-white z-20 hover:shadow-xl flex items-center justify-center" 
                style="background-color: var(--accent-primary);">
            <i data-lucide="plus" class="w-8 h-8"></i>
        </button>

        <!-- Navigation Bar -->
        <nav class="bottom-nav flex justify-around p-2 border-t border-gray-700">
            <button class="nav-button p-2 flex flex-col items-center text-xs" data-tab="home">
                <i data-lucide="home" class="icon w-6 h-6 mb-1 transition-transform duration-300"></i>
                <span>Home</span>
            </button>
            <button class="nav-button p-2 flex flex-col items-center text-xs" data-tab="journal">
                <i data-lucide="calendar-check" class="icon w-6 h-6 mb-1 transition-transform duration-300"></i>
                <span>Journal</span>
            </button>
            <button class="nav-button p-2 flex flex-col items-center text-xs" data-tab="browse">
                <i data-lucide="list" class="icon w-6 h-6 mb-1 transition-transform duration-300"></i>
                <span>Browse</span>
            </button>
            <button class="nav-button p-2 flex flex-col items-center text-xs" data-tab="profile">
                <i data-lucide="user" class="icon w-6 h-6 mb-1 transition-transform duration-300"></i>
                <span>Profile</span>
            </button>
        </nav>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.warn("Could not parse __firebase_config. Using empty config.");
        }
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let persistenceEnabled = Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey;
        const LOCAL_STORAGE_KEY = 'ascendFitUserProfile'; 
        const LOCAL_ACTIVITY_KEY = 'ascendFitActivityLog'; 
        const LAST_RESET_DATE_KEY = 'ascendFitLastReset';
        const MOCK_WEIGHT_TREND_KEY = 'ascendFitWeightTrend'; 

        let db, auth, userId = null;
        let isAuthReady = false;

        // Default User Profile Data
        let userProfile = {
            name: 'Guest User',
            age: 30,
            heightCm: 175,
            weightKg: 70,
            goal: 'Maintain',
            stepGoal: 10000,
            waterGoal: 2.5,
            calorieGoal: 2500, 
            bmi: 22.86,
            heartPointsGoal: 30,
            gender: 'Male', 
            dob: '1995-01-01', 
            lastUpdated: Date.now(),
            bmr: 1680, 
            tdee: 2520,
            moveStreak: 4, 
            cycleStatus: 'Follicular (Day 8)' 
        };
        
        let activityLog = []; 
        let currentDayStats = {
            steps: 0, heartPoints: 0, moveMinutes: 0, 
            water: 0, caloriesBurned: 0, caloriesConsumed: 0
        };
        
        let mockWeightTrend = [70, 70.1, 69.8, 70.5, 70.2, 70.3, 70]; 

        // --- Core Metric Functions ---
        const calculateBMI = (weightKg, heightCm) => {
            if (!weightKg || !heightCm || heightCm === 0) return 0;
            const heightM = heightCm / 100;
            const bmiValue = weightKg / (heightM * heightM);
            return parseFloat(bmiValue.toFixed(2));
        };

        const calculateOffset = (current, goal) => {
            const circumference = 2 * Math.PI * 45; 
            const percentage = Math.min(100, (current / goal) * 100);
            return circumference - (circumference * percentage / 100);
        }

        const renderUserAvatar = () => {
            const avatar = document.getElementById('user-avatar');
            if (avatar) {
                avatar.textContent = userProfile.name.charAt(0).toUpperCase();
            }
        };

        const setHeaderTitle = (tabName) => {
            const titleElement = document.getElementById('header-title');
            let title = '';
            switch (tabName) {
                case 'home': title = 'Home'; break;
                case 'journal': title = 'Journal'; break;
                case 'browse': title = 'Browse Health'; break;
                case 'profile': title = 'Profile'; break;
                case 'settings': title = 'Settings'; break;
                default: title = 'Ascend Fit';
            }
            if (titleElement) {
                titleElement.style.opacity = '0';
                titleElement.style.transform = 'translateY(-5px)';
                setTimeout(() => {
                    titleElement.textContent = title;
                    titleElement.style.opacity = '1';
                    titleElement.style.transform = 'translateY(0)';
                }, 150);
            }
        };
        
        const checkAndResetDailyStats = () => {
            const lastReset = localStorage.getItem(LAST_RESET_DATE_KEY);
            const today = new Date().toDateString();

            if (lastReset !== today) {
                currentDayStats = { steps: 0, heartPoints: 0, moveMinutes: 0, water: 0, caloriesBurned: 0, caloriesConsumed: 0 };
                localStorage.setItem(LAST_RESET_DATE_KEY, today);
                return true;
            }
            return false;
        };

        const recalculateDailyStats = () => {
            checkAndResetDailyStats();
            const today = new Date().toDateString();
            currentDayStats = { steps: 0, heartPoints: 0, moveMinutes: 0, water: 0, caloriesBurned: 0, caloriesConsumed: 0 };
            
            activityLog.forEach(log => {
                const logDate = new Date(log.timestamp).toDateString();
                if (logDate !== today) return; 
                if (log.type === 'Water') { currentDayStats.water += log.amount || 0; } 
                else if (log.type === 'Meal') { currentDayStats.caloriesConsumed += log.calories || 0; } 
                else if (log.type === 'StepWalk') { currentDayStats.steps += log.steps || 0; currentDayStats.heartPoints += log.heartPoints || 0; currentDayStats.moveMinutes += log.duration || 0; } 
                else if (!['Vitals', 'Weight', 'Mood', 'Cycle', 'Sleep'].includes(log.type)) {
                    const duration = parseInt(log.duration);
                    currentDayStats.caloriesBurned += log.calories || 0;
                    currentDayStats.moveMinutes += duration || 0;
                    let stepsPerMin = 80;
                    if (log.type === 'Running' || log.type === 'Cycling') stepsPerMin = 150;
                    currentDayStats.steps += (duration * stepsPerMin) || 0;
                    currentDayStats.heartPoints += Math.floor(duration / 10) || 0;
                }
            });
        };

        const generateMockWeightTrend = (currentWeight) => {
            const trend = [];
            for (let i = 0; i < 7; i++) {
                const variance = (Math.random() * 0.4) - 0.2; 
                trend.push(parseFloat((currentWeight + variance).toFixed(1)));
            }
            return trend;
        };
        
        const saveToStorage = () => {
            if (!persistenceEnabled) {
                localStorage.setItem(LOCAL_ACTIVITY_KEY, JSON.stringify(activityLog));
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(userProfile));
            }
        };

        // --- ANIMATION HELPERS ---
        window.animateNumbers = () => {
             const counters = document.querySelectorAll('.counter-anim');
             counters.forEach(counter => {
                 const target = +counter.getAttribute('data-target');
                 const updateCount = () => {
                     const count = +counter.innerText.replace(/,/g, '').replace('k', '');
                     const inc = target / 30;
                     if (count < target) {
                         counter.innerText = (target % 1 !== 0) ? (count + inc).toFixed(1) : Math.ceil(count + inc).toLocaleString();
                         requestAnimationFrame(updateCount);
                     } else {
                         counter.innerText = (target % 1 !== 0) ? target.toFixed(1) : target.toLocaleString();
                     }
                 };
                 updateCount();
             });
        };

        window.animateChartBars = () => {
             setTimeout(() => {
                 document.querySelectorAll('.chart-bar').forEach((el, index) => {
                     const h = el.getAttribute('data-height');
                     el.style.transition = `height 1s ease-out ${index * 100}ms`;
                     el.style.height = `${h}%`;
                 });
             }, 50);
        }

        // --- MODAL FUNCTIONS ---
        window.showMessage = (title, message, isError = false) => {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div class="modal-content p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 relative bg-[#1A1A2E]" onclick="event.stopPropagation()">
                    <button onclick="window.closeModal()" class="close-btn-absolute"><i data-lucide="x" class="w-6 h-6"></i></button>
                    <div class="flex items-center justify-between border-b pb-2 mb-3 border-gray-700">
                        <h3 class="text-xl font-bold ${isError ? 'text-red-500' : 'text-white'}">${title}</h3>
                    </div>
                    <p class="text-gray-300">${message}</p>
                    <button onclick="window.closeModal()" class="btn-press mt-4 w-full py-2 rounded-lg font-bold transition-all"
                            style="background-color: ${isError ? '#cf6679' : 'var(--accent-primary)'}; color: var(--dark-bg);">
                        CLOSE
                    </button>
                </div>
            `;
            modalContainer.classList.remove('hidden');
            lucide.createIcons();
        };

        window.closeModal = () => {
            const modal = document.getElementById('modal-container');
            modal.classList.add('hidden');
            modal.innerHTML = '';
            window.renderTab(currentTab);
        };

        const createModalContent = (title, formHtml) => {
             return `
                <div class="modal-content p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 relative bg-[#1A1A2E]" onclick="event.stopPropagation()">
                    <button onclick="window.closeModal()" class="close-btn-absolute"><i data-lucide="x" class="w-6 h-6"></i></button>
                    <h3 class="text-xl font-bold text-white border-b pb-2 mb-4 border-gray-700">${title}</h3>
                    ${formHtml}
                </div>
            `;
        };
        
        // --- LOGGING MODALS ---
        window.openWalkModal = () => {
             const form = `<form onsubmit="window.handleWalkLog(event)"><div class="space-y-3"><div><label class="block text-sm font-medium text-gray-400 mb-1">Duration (minutes)</label><input type="number" name="duration" required min="1" value="30" class="input-field w-full px-4 py-2 rounded-lg text-white"></div></div><div class="mt-6 flex justify-between space-x-2"><button type="button" onclick="window.closeModal()" class="btn-press flex-1 py-2 rounded-lg font-bold bg-gray-600 hover:bg-gray-500 text-white">Cancel</button><button type="submit" class="btn-press flex-1 py-2 rounded-lg font-bold" style="background-color: var(--accent-secondary); color: var(--dark-bg);">Log Walk</button></div></form>`;
             document.getElementById('modal-container').innerHTML = createModalContent('Record Walk', form);
             document.getElementById('modal-container').classList.remove('hidden');
        };
        window.handleWalkLog = (e) => {
            e.preventDefault();
            const duration = parseInt(e.target.elements.duration.value, 10);
            activityLog.unshift({ type: 'StepWalk', steps: duration * 90, duration: duration, heartPoints: Math.floor(duration/5), timestamp: Date.now() });
            recalculateDailyStats(); saveToStorage(); window.closeModal();
        };

        window.openCalorieModal = () => {
             const form = `<form onsubmit="window.handleCalorieLog(event)"><div class="space-y-3"><div><label class="block text-sm font-medium text-gray-400 mb-1">Total Calories (Kcal)</label><input type="number" name="calories" required min="1" class="input-field w-full px-4 py-2 rounded-lg text-white"></div></div><div class="mt-6 flex justify-between space-x-2"><button type="button" onclick="window.closeModal()" class="btn-press flex-1 py-2 rounded-lg font-bold bg-gray-600 hover:bg-gray-500 text-white">Cancel</button><button type="submit" class="btn-press flex-1 py-2 rounded-lg font-bold text-gray-900" style="background-color: #FFB300;">Log Meal</button></div></form>`;
             document.getElementById('modal-container').innerHTML = createModalContent('Log Meal Calories', form);
             document.getElementById('modal-container').classList.remove('hidden');
        };
        window.handleCalorieLog = (e) => {
             e.preventDefault();
             activityLog.unshift({ type: 'Meal', calories: parseInt(e.target.elements.calories.value, 10), timestamp: Date.now() });
             recalculateDailyStats(); saveToStorage(); window.closeModal();
        };

        window.openWaterModal = () => {
             const form = `<form onsubmit="window.handleWaterLog(event)"><div class="space-y-3"><div><label class="block text-sm font-medium text-gray-400 mb-1">Water Amount (Liters)</label><input type="number" name="amount" required min="0.1" step="0.1" value="0.5" class="input-field w-full px-4 py-2 rounded-lg text-white"></div></div><div class="mt-6 flex justify-between space-x-2"><button type="button" onclick="window.closeModal()" class="btn-press flex-1 py-2 rounded-lg font-bold bg-gray-600 hover:bg-gray-500 text-white">Cancel</button><button type="submit" class="btn-press flex-1 py-2 rounded-lg font-bold text-gray-900" style="background-color: #448AFF;">Log Water</button></div></form>`;
             document.getElementById('modal-container').innerHTML = createModalContent('Log Water', form);
             document.getElementById('modal-container').classList.remove('hidden');
        };
        window.handleWaterLog = (e) => {
             e.preventDefault();
             activityLog.unshift({ type: 'Water', amount: parseFloat(e.target.elements.amount.value), timestamp: Date.now() });
             recalculateDailyStats(); saveToStorage(); window.closeModal();
        };

        window.openActivityModal = () => {
            const form = `<form onsubmit="window.handleActivityLog(event)"><div class="space-y-3"><div><label class="block text-sm font-medium text-gray-400 mb-1">Type</label><select name="type" class="input-field w-full px-4 py-2 rounded-lg text-white"><option>Running</option><option>Cycling</option><option>Strength</option><option>Yoga</option><option>Other</option></select></div><div><label class="block text-sm font-medium text-gray-400 mb-1">Duration (min)</label><input type="number" name="duration" required class="input-field w-full px-4 py-2 rounded-lg text-white"></div><div><label class="block text-sm font-medium text-gray-400 mb-1">Calories</label><input type="number" name="calories" required class="input-field w-full px-4 py-2 rounded-lg text-white"></div></div><div class="mt-6 flex justify-between space-x-2"><button type="button" onclick="window.closeModal()" class="btn-press flex-1 py-2 rounded-lg font-bold bg-gray-600 hover:bg-gray-500 text-white">Cancel</button><button type="submit" class="btn-press flex-1 py-2 rounded-lg font-bold text-gray-900" style="background-color: var(--accent-primary);">Log</button></div></form>`;
            document.getElementById('modal-container').innerHTML = createModalContent('Log Activity', form);
            document.getElementById('modal-container').classList.remove('hidden');
        };
        window.handleActivityLog = (e) => {
             e.preventDefault();
             activityLog.unshift({ type: e.target.elements.type.value, duration: `${e.target.elements.duration.value} min`, calories: parseInt(e.target.elements.calories.value), timestamp: Date.now() });
             recalculateDailyStats(); saveToStorage(); window.closeModal();
        };
        
        window.openMoodModal = () => {
            const form = `<form onsubmit="window.handleMoodLog(event)"><div class="space-y-3"><div><label class="block text-sm font-medium text-gray-400 mb-1">Select Mood</label><select name="mood" required class="input-field w-full px-4 py-2 rounded-lg text-white"><option>Great</option><option>Good</option><option>Neutral</option><option>Stressed</option><option>Tired</option></select></div></div><div class="mt-6 flex justify-between space-x-2"><button type="button" onclick="window.closeModal()" class="btn-press flex-1 py-2 rounded-lg font-bold bg-gray-600 hover:bg-gray-500 text-white">Cancel</button><button type="submit" class="btn-press flex-1 py-2 rounded-lg font-bold text-gray-900" style="background-color: #7E57C2;">Log Mood</button></div></form>`;
            document.getElementById('modal-container').innerHTML = createModalContent('Log Mood', form);
            document.getElementById('modal-container').classList.remove('hidden');
        };
        window.handleMoodLog = (e) => {
            e.preventDefault(); activityLog.unshift({ type: 'Mood', mood: e.target.elements.mood.value, timestamp: Date.now() }); saveToStorage(); window.closeModal(); showMessage('Mood Logged', 'Thanks for checking in.');
        };
        
        window.openSleepModal = () => {
             const form = `<form onsubmit="window.handleSleepLog(event)"><div class="space-y-3"><div><label class="block text-sm font-medium text-gray-400 mb-1">Duration (Hours)</label><input type="number" name="duration" required min="1" step="0.1" value="8.0" class="input-field w-full px-4 py-2 rounded-lg text-white"></div><div><label class="block text-sm font-medium text-gray-400 mb-1">Quality (1-5)</label><input type="number" name="quality" required min="1" max="5" value="4" class="input-field w-full px-4 py-2 rounded-lg text-white"></div></div><div class="mt-6 flex justify-between space-x-2"><button type="button" onclick="window.closeModal()" class="btn-press flex-1 py-2 rounded-lg font-bold bg-gray-600 hover:bg-gray-500 text-white">Cancel</button><button type="submit" class="btn-press flex-1 py-2 rounded-lg font-bold text-gray-900" style="background-color: #7E57C2;">Log Sleep</button></div></form>`;
             document.getElementById('modal-container').innerHTML = createModalContent('Log Sleep', form);
             document.getElementById('modal-container').classList.remove('hidden');
        };
        window.handleSleepLog = (e) => {
             e.preventDefault(); activityLog.unshift({ type: 'Sleep', duration: parseFloat(e.target.elements.duration.value), quality: parseInt(e.target.elements.quality.value), timestamp: Date.now() }); saveToStorage(); window.closeModal(); showMessage('Sleep Logged', 'Good night!');
        };
        
        // --- RESTORED MODALS ---
        window.openEditNameModal = () => {
             const form = `<form onsubmit="window.handleNameUpdate(event)"><div class="space-y-3"><div><label class="block text-sm font-medium text-gray-400 mb-1">Name</label><input type="text" name="name" required value="${userProfile.name}" class="input-field w-full px-4 py-2 rounded-lg text-white"></div></div><div class="mt-6 flex justify-between space-x-2"><button type="button" onclick="window.closeModal()" class="btn-press flex-1 py-2 rounded-lg font-bold bg-gray-600 hover:bg-gray-500 text-white">Cancel</button><button type="submit" class="btn-press flex-1 py-2 rounded-lg font-bold text-gray-900" style="background-color: var(--accent-primary);">Save Name</button></div></form>`;
             document.getElementById('modal-container').innerHTML = createModalContent('Edit Name', form);
             document.getElementById('modal-container').classList.remove('hidden');
        };
        window.handleNameUpdate = (e) => {
            e.preventDefault(); userProfile.name = e.target.elements.name.value; userProfile.lastUpdated = Date.now();
            saveProfile(userProfile); window.closeModal(); showMessage('Profile Updated', `Hi, ${userProfile.name}!`);
        };

        window.openWeightModal = () => {
            const form = `<form onsubmit="window.handleWeightLog(event)"><div class="space-y-3"><div><label class="block text-sm font-medium text-gray-400 mb-1">Weight (kg)</label><input type="number" name="weight" required min="10" step="0.1" value="${userProfile.weightKg}" class="input-field w-full px-4 py-2 rounded-lg text-white"></div></div><div class="mt-6 flex justify-between space-x-2"><button type="button" onclick="window.closeModal()" class="btn-press flex-1 py-2 rounded-lg font-bold bg-gray-600 hover:bg-gray-500 text-white">Cancel</button><button type="submit" class="btn-press flex-1 py-2 rounded-lg font-bold text-gray-900" style="background-color: var(--accent-primary);">Log Weight</button></div></form>`;
            document.getElementById('modal-container').innerHTML = createModalContent('Log Weight', form);
            document.getElementById('modal-container').classList.remove('hidden');
        };
        window.handleWeightLog = (e) => {
            e.preventDefault();
            const newWeight = parseFloat(e.target.elements.weight.value);
            userProfile.weightKg = newWeight; userProfile.lastUpdated = Date.now();
            mockWeightTrend.shift(); mockWeightTrend.push(newWeight);
            localStorage.setItem(MOCK_WEIGHT_TREND_KEY, JSON.stringify(mockWeightTrend));
            activityLog.unshift({ type: 'Weight', weight: newWeight, timestamp: Date.now() });
            saveProfile(userProfile); window.closeModal(); showMessage('Weight Updated', `New weight: ${newWeight} kg.`);
        };
        
        window.openActivityGoalModal = () => {
            const form = `<form onsubmit="window.handleActivityGoalLog(event)"><div class="space-y-3"><div><label class="block text-sm font-medium text-gray-400 mb-1">Daily Steps</label><input type="number" name="stepGoal" required min="1000" step="100" value="${userProfile.stepGoal}" class="input-field w-full px-4 py-2 rounded-lg text-white"></div><div><label class="block text-sm font-medium text-gray-400 mb-1">Heart Points</label><input type="number" name="hpGoal" required min="10" step="5" value="${userProfile.heartPointsGoal}" class="input-field w-full px-4 py-2 rounded-lg text-white"></div><div><label class="block text-sm font-medium text-gray-400 mb-1">Calorie Goal</label><input type="number" name="calorieGoal" required min="1000" step="100" value="${userProfile.calorieGoal}" class="input-field w-full px-4 py-2 rounded-lg text-white"></div></div><div class="mt-6 flex justify-between space-x-2"><button type="button" onclick="window.closeModal()" class="btn-press flex-1 py-2 rounded-lg font-bold bg-gray-600 hover:bg-gray-500 text-white">Cancel</button><button type="submit" class="btn-press flex-1 py-2 rounded-lg font-bold text-gray-900" style="background-color: var(--accent-primary);">Save Goals</button></div></form>`;
            document.getElementById('modal-container').innerHTML = createModalContent('Set Goals', form);
            document.getElementById('modal-container').classList.remove('hidden');
        };
        window.handleActivityGoalLog = (e) => {
            e.preventDefault();
            userProfile.stepGoal = parseInt(e.target.elements.stepGoal.value);
            userProfile.heartPointsGoal = parseInt(e.target.elements.hpGoal.value);
            userProfile.calorieGoal = parseInt(e.target.elements.calorieGoal.value);
            saveProfile(userProfile); window.closeModal(); showMessage('Goals Updated', 'Keep pushing!');
        };

        window.openVitalsModal = () => {
             const form = `<form onsubmit="window.handleVitalsLog(event)"><div class="space-y-3"><div><label class="block text-sm font-medium text-gray-400 mb-1">BP</label><input type="text" name="bp" value="120/80" class="input-field w-full px-4 py-2 rounded-lg text-white"></div><div><label class="block text-sm font-medium text-gray-400 mb-1">HR (BPM)</label><input type="number" name="hr" value="75" class="input-field w-full px-4 py-2 rounded-lg text-white"></div></div><div class="mt-6 flex justify-between space-x-2"><button type="button" onclick="window.closeModal()" class="btn-press flex-1 py-2 rounded-lg font-bold bg-gray-600 hover:bg-gray-500 text-white">Cancel</button><button type="submit" class="btn-press flex-1 py-2 rounded-lg font-bold text-gray-900" style="background-color: #F06292;">Log</button></div></form>`;
             document.getElementById('modal-container').innerHTML = createModalContent('Log Vitals', form);
             document.getElementById('modal-container').classList.remove('hidden');
        };
        window.handleVitalsLog = (e) => {
            e.preventDefault(); activityLog.unshift({ type: 'Vitals', bp: e.target.elements.bp.value, hr: parseInt(e.target.elements.hr.value), timestamp: Date.now() }); saveToStorage(); window.closeModal();
        };
        
        window.openCycleModal = () => {
             const html = `<div><div class="space-y-2"><button onclick="window.handleCycleLog('Flow: Light')" class="btn-press w-full py-2 rounded bg-pink-900/50 text-pink-300 border border-pink-700 hover:bg-pink-900">Light</button><button onclick="window.handleCycleLog('Flow: Medium')" class="btn-press w-full py-2 rounded bg-pink-900/50 text-pink-300 border border-pink-700 hover:bg-pink-900">Medium</button><button onclick="window.handleCycleLog('Flow: Heavy')" class="btn-press w-full py-2 rounded bg-pink-900/50 text-pink-300 border border-pink-700 hover:bg-pink-900">Heavy</button></div></div>`;
             document.getElementById('modal-container').innerHTML = createModalContent('Log Cycle', html);
             document.getElementById('modal-container').classList.remove('hidden');
        };
        window.handleCycleLog = (detail) => {
            activityLog.unshift({ type: 'Cycle', detail: detail, timestamp: Date.now() }); saveToStorage(); window.closeModal(); showMessage('Cycle Tracked', `Logged ${detail}`);
        };


        const getProfileDocRef = () => {
            if (!db || !userId) return null;
            return doc(db, `artifacts/${appId}/users/${userId}/profile/user_data`);
        };

        // --- Firebase Initialization ---
        const initializeFirebase = async () => {
            try {
                if (!persistenceEnabled) {
                    const localProfileData = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (localProfileData) userProfile = { ...userProfile, ...JSON.parse(localProfileData) };
                    userProfile.bmi = calculateBMI(userProfile.weightKg, userProfile.heightCm);
                    
                    const localActivityData = localStorage.getItem(LOCAL_ACTIVITY_KEY);
                    if (localActivityData) activityLog = JSON.parse(localActivityData);
                    
                    const localWeightTrend = localStorage.getItem(MOCK_WEIGHT_TREND_KEY);
                    if (localWeightTrend) mockWeightTrend = JSON.parse(localWeightTrend);
                    else mockWeightTrend = generateMockWeightTrend(userProfile.weightKg);
                    
                    recalculateDailyStats(); 
                    document.getElementById('loading').style.opacity = '0';
                    setTimeout(() => document.getElementById('loading').classList.add('hidden'), 500);
                    isAuthReady = true; userId = crypto.randomUUID(); 
                    renderUserAvatar(); renderTab('home'); 
                    return; 
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); } else { await signInAnonymously(auth); }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; isAuthReady = true;
                        document.getElementById('loading').style.opacity = '0';
                        setTimeout(() => document.getElementById('loading').classList.add('hidden'), 500);
                        loadProfile(); renderUserAvatar(); renderTab('home');
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loading').innerHTML = `<p class="text-red-500">Error loading app.</p>`;
            }
        };

        const loadProfile = () => {
            if (!isAuthReady || !userId || !persistenceEnabled) return;
            onSnapshot(getProfileDocRef(), (docSnap) => {
                if (docSnap.exists()) { userProfile = { ...userProfile, ...docSnap.data() }; userProfile.bmi = calculateBMI(userProfile.weightKg, userProfile.heightCm); } 
                else { saveProfile(userProfile); }
                renderUserAvatar(); renderTab(document.querySelector('.nav-button.active')?.dataset.tab || 'home');
            });
        };

        const saveProfile = async (data) => {
            data.bmi = calculateBMI(data.weightKg, data.heightCm);
            userProfile = data; userProfile.lastUpdated = Date.now();
            mockWeightTrend = generateMockWeightTrend(userProfile.weightKg);
            localStorage.setItem(MOCK_WEIGHT_TREND_KEY, JSON.stringify(mockWeightTrend));
            
            if (!isAuthReady || !userId) { renderTab(currentTab); return; }
            if (!persistenceEnabled) { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data)); renderUserAvatar(); renderTab(currentTab); return; }
            try { await setDoc(getProfileDocRef(), data, { merge: true }); renderUserAvatar(); renderTab(currentTab); } catch (e) { console.error(e); }
        };

        // --- UI Rendering ---
        let currentTab = 'home';
        const renderTab = (tabName) => {
            const contentArea = document.getElementById('content-area');
            const fab = document.getElementById('fab-log-activity');
            
            contentArea.classList.remove('animate-fade');
            void contentArea.offsetWidth; 
            contentArea.innerHTML = '';
            
            currentTab = tabName;
            setHeaderTitle(tabName);
            
            if (tabName === 'journal') fab.classList.remove('hidden');
            else fab.classList.add('hidden');

            let htmlContent = '';
            switch (tabName) {
                case 'home': htmlContent = renderHome(); break;
                case 'journal': htmlContent = renderJournal(); break;
                case 'browse': htmlContent = renderBrowse(); break;
                case 'profile': htmlContent = renderProfile(); break;
                case 'category_detail': htmlContent = renderCategoryDetail(window.activeCategory); break;
                case 'settings': htmlContent = renderSettings(); break;
                default: htmlContent = renderHome();
            }
            
            contentArea.innerHTML = htmlContent;
            contentArea.classList.add('animate-fade');
            
            if(tabName === 'profile') attachProfileListeners();
            if(tabName === 'category_detail') window.animateChartBars();
            if(['home', 'journal', 'category_detail'].includes(tabName)) window.animateNumbers();

            lucide.createIcons();
        };
        window.renderTab = renderTab;

        const renderHome = () => {
            const hpOffset = calculateOffset(currentDayStats.heartPoints, userProfile.heartPointsGoal);
            const stepsOffset = calculateOffset(currentDayStats.steps, userProfile.stepGoal);
            const waterProgressPct = Math.min(100, (currentDayStats.water / userProfile.waterGoal) * 100);
            const caloriesNet = currentDayStats.caloriesConsumed - currentDayStats.caloriesBurned;
            const caloriesProgressPct = Math.min(100, (currentDayStats.caloriesConsumed / userProfile.calorieGoal) * 100);
            const caloriesColor = caloriesNet <= userProfile.calorieGoal * 1.1 ? '#00BFA5' : '#FF5050'; 
            
            const minWeight = Math.min(...mockWeightTrend);
            const maxWeight = Math.max(...mockWeightTrend);
            const range = maxWeight - minWeight === 0 ? 1 : maxWeight - minWeight;
            const points = mockWeightTrend.map((w, i) => {
                const x = i * 14.28 + 7; const y = 100 - ((w - minWeight) / range) * 100;
                return `${x},${y}`;
            }).join(' ');

            return `
                <div class="space-y-5 pb-20">
                    <p class="text-xs text-gray-500 mb-0 px-2 animate-enter delay-0 text-center">${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                    <div class="flex flex-col items-center pt-4 animate-enter delay-1">
                        <div class="relative w-40 h-40 animate-float">
                            <svg width="100%" height="100%" viewBox="0 0 100 100" class="absolute transform rotate-[-90deg]">
                                <circle cx="50" cy="50" r="45" fill="none" class="gauge-ring-bg" stroke-width="6"/>
                                <circle cx="50" cy="50" r="45" fill="none" class="outer-ring gauge-ring-fill" stroke-width="6" stroke-linecap="round" style="stroke-dasharray: 283; stroke-dashoffset: ${hpOffset};"/>
                                <circle cx="50" cy="50" r="38" fill="none" class="gauge-ring-bg" stroke-width="6"/>
                                <circle cx="50" cy="50" r="38" fill="none" class="inner-ring gauge-ring-fill" stroke-width="6" stroke-linecap="round" style="stroke-dasharray: 238.76; stroke-dashoffset: ${stepsOffset * 0.844};"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <p class="text-4xl font-extrabold text-white counter-anim" data-target="${currentDayStats.heartPoints}">0</p>
                                <p class="text-xs font-semibold text-gray-400 mt-0">/ ${userProfile.heartPointsGoal} HP</p>
                            </div>
                        </div>
                        <div class="flex justify-center space-x-6 mt-6 text-center animate-enter delay-2">
                            <div class="transform transition hover:scale-105">
                                <p class="text-xl font-bold text-white counter-anim" data-target="${currentDayStats.steps}">0</p>
                                <p class="text-xs text-gray-400">Total Steps</p>
                            </div>
                             <div class="border-r border-divider-color mx-2"></div>
                             <div class="transform transition hover:scale-105">
                                <p class="text-xl font-bold text-white counter-anim" data-target="${currentDayStats.moveMinutes}">0</p>
                                <p class="text-xs text-gray-400">Move Min</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="window.openWalkModal()" class="w-full py-3 rounded-xl font-bold text-lg shadow-xl transition-all duration-300 transform hover:scale-[1.02] active:scale-95 animate-enter delay-3 btn-press" style="background-color: var(--accent-secondary); color: var(--dark-bg);">
                        <i data-lucide="walk" class="inline-block w-5 h-5 mr-2 animate-bounce"></i> Record Walk Duration
                    </button>
                    <div class="grid grid-cols-2 gap-4 animate-enter delay-4">
                        <div class="card-glow p-4 rounded-xl shadow-lg flex flex-col justify-between overflow-hidden relative" style="background-color: var(--card-bg);">
                            <div class="flex items-center justify-between mb-3 z-10"><p class="text-base font-semibold text-white">Hydration</p><button onclick="window.openWaterModal()" class="w-6 h-6 rounded-full bg-blue-900 text-blue-400 flex items-center justify-center hover:bg-blue-800 water-button transition-transform hover:rotate-90"><i data-lucide="plus" class="w-4 h-4"></i></button></div>
                            <div class="relative h-32 flex justify-center items-end z-10">
                                <svg width="70" height="130" viewBox="0 0 50 100" class="absolute bottom-0 drop-shadow-lg">
                                    <defs><linearGradient id="waterGradient" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#448AFF; stop-opacity:1" /><stop offset="100%" style="stop-color:#00BFFF; stop-opacity:0.6" /></linearGradient></defs>
                                    <path d="M 10 10 C 10 0, 40 0, 40 10 V 90 A 5 5 0 0 1 35 95 H 15 A 5 5 0 0 1 10 90 V 10 Z" stroke="#A0A0A0" stroke-width="1.5" fill="#21212100"/>
                                    <rect x="11" y="94" width="28" height="0" rx="4" class="water-fill" style="height: ${waterProgressPct * 0.85}%; transform: translateY(-${waterProgressPct * 0.85}%); fill: url(#waterGradient);"/>
                                </svg>
                                <p class="absolute top-1/3 text-lg font-bold text-white z-10 counter-anim" data-target="${currentDayStats.water.toFixed(1)}">0.0</p>
                            </div>
                        </div>
                        <div class="card-glow p-4 rounded-xl shadow-lg flex flex-col justify-between" style="background-color: var(--card-bg);">
                            <div class="flex items-center justify-between mb-2"><p class="text-base font-semibold text-white">Net Cals</p><button onclick="window.openCalorieModal()" class="w-6 h-6 rounded-full bg-red-900 text-red-400 flex items-center justify-center hover:bg-red-800 water-button transition-transform hover:rotate-90"><i data-lucide="plus" class="w-4 h-4"></i></button></div>
                            <p class="text-3xl font-extrabold mt-2 counter-anim" data-target="${caloriesNet}" style="color: ${caloriesColor};">0</p>
                            <div class="w-full bg-gray-700 rounded-lg h-5 mt-auto overflow-hidden"><div class="h-full calorie-bar rounded-lg relative" style="width: ${caloriesProgressPct}%; background-color: ${caloriesColor}; box-shadow: 0 0 8px ${caloriesColor}50;"></div></div>
                        </div>
                    </div>
                    <div class="card-glow p-4 rounded-xl shadow-lg animate-enter delay-5" style="background-color: var(--card-bg);">
                        <div class="flex justify-between items-center mb-2"><h3 class="text-xl font-medium text-gray-300">Weight Trend</h3></div>
                        <div class="flex justify-between items-center"><div><p class="text-3xl font-extrabold text-white counter-anim" data-target="${userProfile.weightKg}">0</p> <span class="text-sm text-gray-400">kg</span></div><div class="text-right"><span class="px-3 py-1 rounded-full text-xs font-semibold mt-1 inline-block animate-pulse" style="background-color: var(--accent-secondary); color: var(--dark-bg);">${userProfile.goal}</span></div></div>
                         <div class="mt-4 h-20 w-full"><svg viewBox="0 0 100 100" preserveAspectRatio="none" class="w-full h-full"><polyline class="trend-line" points="${points}" stroke="var(--accent-primary)"/><circle cx="${points.split(' ').pop().split(',')[0]}" cy="${points.split(' ').pop().split(',')[1]}" r="3" fill="var(--accent-primary)" class="animate-ping" style="animation-duration: 3s;" /></svg></div>
                    </div>
                </div>
            `;
        };

        const renderJournal = () => {
            const recentActivities = activityLog.filter(log => log.timestamp > Date.now() - (7 * 24 * 60 * 60 * 1000)); 
            const activityList = recentActivities.map((log, index) => {
                let icon, color, value;
                if (log.type === 'Water') { icon = 'droplet'; color = 'text-blue-400'; value = `+${log.amount} L`; }
                else if (log.type === 'Meal') { icon = 'apple'; color = 'text-red-400'; value = `+${log.calories} Kcal`; }
                else if (log.type === 'Sleep') { icon = 'moon'; color = 'text-purple-400'; value = `${log.duration} hrs`; }
                else if (log.type === 'StepWalk') { icon = 'walk'; color = 'text-yellow-400'; value = `+${log.steps} Steps`; }
                else if (log.type === 'Vitals') { icon = 'heart-pulse'; color = '#F06292'; value = `${log.bp}`; }
                else if (log.type === 'Cycle') { icon = 'circle-dot'; color = '#F06292'; value = log.detail; }
                else { icon = 'dumbbell'; color = 'text-green-400'; value = `${log.calories} Kcal`; }
                const delay = Math.min(index * 100, 1000); 
                return `
                    <div class="flex justify-between items-center p-3 hover:bg-gray-700/50 transition-colors border-b border-divider-color last:border-b-0 animate-enter" style="animation-delay: ${delay}ms">
                        <div class="flex items-center space-x-4"><div class="p-2 rounded-full bg-gray-800/50"><i data-lucide="${icon}" class="w-6 h-6 ${color}"></i></div><div><p class="font-medium text-white">${log.type}</p></div></div>
                        <div class="text-right"><p class="text-sm font-semibold text-white">${value}</p><p class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</p></div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="space-y-4 pb-20">
                    <h2 class="text-3xl font-extrabold mb-2 text-white animate-enter delay-0">Journal</h2>
                    <div class="grid grid-cols-3 gap-4 animate-enter delay-1">
                        <button onclick="window.openMoodModal()" class="btn-press py-2 rounded-xl text-sm font-bold text-white shadow-lg transform transition hover:scale-105" style="background-color: #7E57C2;"><i data-lucide="smile" class="w-4 h-4 inline mr-1"></i> Mood</button>
                        <button onclick="window.openSleepModal()" class="btn-press py-2 rounded-xl text-sm font-bold text-white shadow-lg transform transition hover:scale-105" style="background-color: #448AFF;"><i data-lucide="moon" class="w-4 h-4 inline mr-1"></i> Sleep</button>
                        <button onclick="window.openActivityModal('Workout')" class="btn-press py-2 rounded-xl text-sm font-bold text-white shadow-lg transform transition hover:scale-105" style="background-color: var(--accent-primary); color: var(--dark-bg);"><i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> Workout</button>
                    </div>
                    ${recentActivities.length === 0 ? `<div class="flex flex-col items-center justify-center text-center p-12 mt-10 rounded-xl animate-enter delay-2" style="background-color: var(--card-bg);"><i data-lucide="clipboard-list" class="w-12 h-12 mb-4 text-gray-500 animate-bounce"></i><p class="text-white text-lg font-medium">No logs yet</p></div>` : `<div class="rounded-xl shadow-lg animate-enter delay-2" style="background-color: var(--card-bg);"><div class="p-3">${activityList}</div></div>`}
                </div>
            `;
        };

        const renderBrowse = () => {
            const categories = [
                { name: "Activity", icon: "footsteps", color: "#00BFA5" },
                { name: "Body measurements", icon: "ruler", color: "#448AFF" },
                { name: "Vitals", icon: "heart-pulse", color: "#F06292" },
                { name: "Nutrition", icon: "utensils", color: "#FFB300" },
                { name: "Sleep", icon: "moon", color: "#7E57C2" },
                { name: "Cycle tracking", icon: "circle-dot", color: "#D81B60" },
            ];
            const categoryList = categories.map((cat, i) => `
                <div class="flex items-center list-group-item border-b border-divider-color last:border-b-0 animate-enter" style="animation-delay: ${i * 70}ms" onclick="window.handleCategoryClick('${cat.name}', '${cat.icon}', '${cat.color}')">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center mr-4 transition-transform hover:rotate-12" style="background-color: ${cat.color}33;"><i data-lucide="${cat.icon}" class="w-5 h-5" style="color: ${cat.color};"></i></div>
                    <p class="text-base">${cat.name}</p><i data-lucide="chevron-right" class="w-5 h-5 text-gray-500 ml-auto transition-transform group-hover:translate-x-1"></i>
                </div>
            `).join('');
            return `
                <div class="space-y-6 pb-20">
                    <div class="relative animate-enter delay-0"><input type="text" placeholder="Search health data" class="input-field w-full py-3 pl-12 pr-4 rounded-full text-base" style="background-color: var(--card-bg);"><i data-lucide="search" class="w-5 h-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i></div>
                    <div class="rounded-xl p-4 shadow-lg" style="background-color: var(--card-bg);">${categoryList}</div>
                </div>
            `;
        };
        window.handleCategoryClick = (categoryName, icon, color) => { window.activeCategory = { name: categoryName, icon: icon, color: color }; window.renderTab('category_detail'); };

        const renderCategoryDetail = (category) => {
            let currentMetric = '---', secondaryAction = '';
            if (category.name === 'Nutrition') { currentMetric = `${currentDayStats.caloriesConsumed}`; secondaryAction = `<button onclick="window.openCalorieModal()" class="btn-press w-full py-2 rounded-lg font-bold text-white mt-4 transition-transform active:scale-95" style="background-color: ${category.color};">Log Meal</button>`; }
            else if (category.name === 'Activity') { currentMetric = `${currentDayStats.steps}`; secondaryAction = `<button onclick="window.openWalkModal()" class="btn-press w-full py-2 rounded-lg font-bold text-white mt-4" style="background-color: ${category.color};">Record Walk</button>`; }
            else if (category.name === 'Vitals') { currentMetric = '120/80'; secondaryAction = `<button onclick="window.openVitalsModal()" class="btn-press w-full py-2 rounded-lg font-bold text-white mt-4" style="background-color: ${category.color};">Log Vitals</button>`; }
            else if (category.name === 'Cycle tracking') { currentMetric = 'Day 8'; secondaryAction = `<button onclick="window.openCycleModal()" class="btn-press w-full py-2 rounded-lg font-bold text-white mt-4" style="background-color: ${category.color};">Log Flow</button>`; }
            else { secondaryAction = `<button onclick="window.showMessage('Info', 'Action Mocked')" class="btn-press w-full py-2 rounded-lg font-bold text-white mt-4" style="background-color: ${category.color};">Log Data</button>`; }
            
            // Generate Bar HTML without embedded script
            const barsHtml = [20, 45, 60, 30, 75, 50, 90].map((h, i) => `
                <div class="w-3 rounded-t-full chart-bar" 
                     data-height="${h}"
                     style="height: 0; background-color: ${i === 6 ? category.color : '#383838'};">
                </div>
            `).join('');

            return `
                <div class="space-y-6 pb-20 animate-enter">
                    <div class="flex items-center space-x-3 mb-6"><button onclick="window.renderTab('browse')" class="p-2 rounded-full hover:bg-gray-800 transition-colors"><i data-lucide="chevron-left" class="w-6 h-6 text-white"></i></button><h2 class="text-3xl font-normal text-white">${category.name}</h2></div>
                    <div class="card-glow p-5 rounded-xl shadow-lg border-t-4 animate-pop" style="background-color: var(--card-bg); border-color: ${category.color};">
                        <div class="flex justify-between items-start mb-4"><div class="flex items-center"><i data-lucide="${category.icon}" class="w-8 h-8 mr-3 animate-bounce" style="color: ${category.color};"></i><div><p class="text-lg font-semibold text-white">Daily Summary</p></div></div><p class="text-xl font-bold text-white counter-anim" data-target="${currentMetric.replace(/[^0-9.]/g, '') || 0}">0</p></div>
                        <div class="mt-4 p-4 rounded-xl shadow-inner" style="background-color: #1A1A1A;">
                            <h4 class="text-sm text-gray-400 mb-2">Trend</h4>
                            <div class="flex justify-around items-end h-20">${barsHtml}</div>
                        </div>
                        ${secondaryAction}
                    </div>
                </div>
            `;
        };

        const renderProfile = () => {
             return `
                <div class="space-y-6 pb-20">
                    <div class="flex justify-between items-center px-2 animate-enter delay-0"><h2 class="text-3xl font-normal text-white">Profile</h2><i data-lucide="settings" class="w-6 h-6 text-gray-400 cursor-pointer hover:text-white transition-transform hover:rotate-90" onclick="window.renderTab('settings')"></i></div>
                    
                    <div class="p-4 rounded-xl shadow-lg card-glow animate-enter delay-1" style="background-color: var(--card-bg);">
                        <form id="profileForm" class="space-y-4">
                            <div class="flex justify-between items-center border-b border-divider-color pb-3 mb-4">
                                <div><p class="text-sm font-medium text-gray-400">Current BMI</p><p class="text-2xl font-bold text-green-400">${userProfile.bmi}</p></div>
                                <button type="button" onclick="window.showMessage('BMI', 'BMI = weight(kg) / height(m)')" class="btn-press text-xs font-bold text-white py-1 px-3 rounded-full bg-gray-700 hover:bg-gray-600 transition-colors">BMI Info</button>
                            </div>

                            <div class="flex justify-between items-center mb-2">
                                <p class="list-group-header mb-0 p-0">Personal Details</p>
                                <button type="button" onclick="window.openEditNameModal()" class="text-xs text-accent-secondary hover:text-white transition-colors">Edit Name</button>
                            </div>
                            
                            <div class="mb-4 bg-[#141420] p-3 rounded-lg flex justify-between items-center">
                                <div><p class="text-xs text-gray-500">Name</p><p class="text-white font-medium">${userProfile.name}</p></div>
                                <div><p class="text-xs text-gray-500">Gender</p><p class="text-white font-medium">${userProfile.gender}</p></div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-400 mb-1">Age</label><input type="number" id="profileAge" value="${userProfile.age}" class="input-field w-full px-4 py-2 rounded-lg text-white"></div>
                                <div><label class="block text-sm font-medium text-gray-400 mb-1">Height (cm)</label><input type="number" id="profileHeight" value="${userProfile.heightCm}" class="input-field w-full px-4 py-2 rounded-lg text-white"></div>
                            </div>
                            
                            <div class="flex items-end space-x-2 mt-2">
                                <div class="flex-grow"><label class="block text-sm font-medium text-gray-400 mb-1">Weight (kg)</label><div class="input-field w-full px-4 py-2 rounded-lg text-white flex items-center justify-between"><span>${userProfile.weightKg}</span><i data-lucide="edit-2" class="w-4 h-4 text-gray-500 cursor-pointer" onclick="window.openWeightModal()"></i></div></div>
                            </div>

                            <div class="flex justify-between items-center mt-6 mb-2">
                                <p class="list-group-header mb-0 p-0">Daily Goals</p>
                                <button type="button" onclick="window.openActivityGoalModal()" class="text-xs text-accent-secondary hover:text-white transition-colors">Edit Goals</button>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div class="bg-[#141420] p-2 rounded-lg"><p class="text-xs text-gray-500">Steps</p><p class="text-white font-bold text-sm">${userProfile.stepGoal/1000}k</p></div>
                                <div class="bg-[#141420] p-2 rounded-lg"><p class="text-xs text-gray-500">Points</p><p class="text-white font-bold text-sm">${userProfile.heartPointsGoal}</p></div>
                                <div class="bg-[#141420] p-2 rounded-lg"><p class="text-xs text-gray-500">Cals</p><p class="text-white font-bold text-sm">${userProfile.calorieGoal}</p></div>
                            </div>
                            
                            <button type="submit" id="saveProfileBtn" class="btn-press w-full py-3 rounded-xl font-bold text-lg shadow-xl mt-6 transform transition hover:scale-[1.02]" style="background-color: var(--accent-primary); color: var(--dark-bg);">SAVE PROFILE</button>
                            <p id="saveMessage" class="text-center text-sm mt-2 text-green-400 opacity-0 transition-opacity duration-300">Profile Updated Successfully!</p>
                        </form>
                    </div>
                </div>
            `;
        };
        const attachProfileListeners = () => {
            const form = document.getElementById('profileForm');
            if (form) {
                form.onsubmit = (e) => {
                    e.preventDefault(); 
                    userProfile.age = parseInt(document.getElementById('profileAge').value); 
                    userProfile.heightCm = parseInt(document.getElementById('profileHeight').value);
                    saveProfile(userProfile);
                    const msg = document.getElementById('saveMessage'); msg.classList.remove('opacity-0'); setTimeout(() => msg.classList.add('opacity-0'), 2000);
                };
            }
        };

        const renderSettings = () => {
            return `
                <div class="space-y-6 animate-enter">
                    <h2 class="text-3xl font-normal mb-6 text-white">Settings</h2>
                    <div class="space-y-1">
                        <div class="list-group-item border-b border-divider-color animate-enter delay-1"><p class="text-base">Units</p></div>
                        <div class="list-group-item border-b border-divider-color animate-enter delay-2" onclick="localStorage.clear(); location.reload();"><p class="text-base text-red-500">Reset App Data</p></div>
                    </div>
                </div>
            `;
        };

        const setupNavigation = () => {
            document.querySelectorAll('.nav-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    renderTab(e.currentTarget.dataset.tab);
                });
            });
            document.querySelector('.nav-button[data-tab="home"]').classList.add('active');
        };

        window.onload = () => {
            setupNavigation();
            initializeFirebase();
        };

    </script>
</body>
</html>